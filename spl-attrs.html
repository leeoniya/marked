<!doctype html>
<html>
<head>
  <title>Marked Special Attrs</title>
  <script src="lib/marked.js"></script>
</head>
<body>
  <script>
    const attrsCache = {};

    const RE_ID       = /#([-\w]+)/;
    const RE_CLASSES  = /\.([-\w.]+)/;
    const RE_ATTRS    = /\[([^=\]]+)=?([^\]]+)?\]/g;

    function parseAttrs(raw) {
      if (attrsCache[raw] == null) {
        var m, attrs = {};

        if (m = raw.match(RE_ID))
          attrs.id = m[1];

        if (m = raw.match(RE_CLASSES))
          attrs.class = m[1].replace(/\./g, " ");

        while (m = RE_ATTRS.exec(raw))
          attrs[m[1]] = m[2];

        var hasAttrs = false;

        for (var attr in attrs) {
          hasAttrs = true;
          break;
        }

        attrsCache[raw] = hasAttrs ? attrs : null;
      }

      return attrsCache[raw];
    }

    const RE_ATTRS2 = /^(.+)\s+\{(.+)\}$/;

    function render(markdown) {
      var tokens = marked.lexer(markdown);

      tokens.forEach(function(t) {
        if (t.type != 'html') {
          var m = t.text.match(RE_ATTRS2);
          t.text = m[1];
          t.attrs = parseAttrs(m[2]);
        }
      });

      return marked.parser(tokens);
    }

    const inputs = [
      // heading
      '# My Heading {#foo.bar.baz[moo=cow][cat]}',
      // <img>
      '![alt text](https://via.placeholder.com/350x150 "Logo Title Text 1") {#foo.bar.baz[moo=cow][cat]}',
      // <a>
      '[I\'m an inline-style link with title](https://www.google.com "Google\'s Homepage") {#foo.bar.baz[moo=cow][cat]}',
    ];

    inputs.forEach(function(inp) {
      var markup = render(inp);
      console.log(markup);
      document.body.insertAdjacentHTML('beforeend', markup);
    });
  </script>
</body>
</html>